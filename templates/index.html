<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Document AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4338CA;
            --primary-hover: #3730A3;
            --primary-light: #EEF2FF;
            --secondary: #F3F4F6;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94A3B8; 
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }
            70% {
                transform: scale(1);
                opacity: 0;
            }
            100% {
                transform: scale(0.8);
                opacity: 0;
            }
        }
        
        .animate-pulse-ring:before {
            content: '';
            position: absolute;
            left: -5px;
            top: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background-color: #4338CA;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            z-index: -1;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #6366F1;
            margin: 0 1px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        
        .message-appear {
            animation: appear 0.3s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        
        @keyframes appear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .markdown pre {
            background-color: #F1F5F9;
            padding: 0.75rem;
            border-radius: 0.375rem;
            overflow-x: auto;
            margin: 0.75rem 0;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .markdown code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background-color: #F1F5F9;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        .markdown ul, .markdown ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }
        
        .markdown ul {
            list-style-type: disc;
        }
        
        .markdown ol {
            list-style-type: decimal;
        }
        
        .markdown a {
            color: #4338CA;
            text-decoration: underline;
        }
        
        .markdown blockquote {
            border-left: 3px solid #E2E8F0;
            padding-left: 1rem;
            color: #64748B;
            margin: 0.75rem 0;
        }
        
        .tooltip {
            position: relative;
        }
        
        .tooltip:after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1F2937;
            color: white;
            text-align: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
        }
        
        .tooltip:before {
            content: '';
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translate(-50%, 100%);
            border-width: 4px;
            border-style: solid;
            border-color: #1F2937 transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
        }
        
        .tooltip:hover:after, .tooltip:hover:before {
            opacity: 1;
            visibility: visible;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .mobile-hidden {
                display: none;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 md:p-4 bg-gradient-to-br from-indigo-50 to-gray-50">
    <div class="w-full max-w-4xl bg-white shadow-lg rounded-xl overflow-hidden border border-gray-200 transition-all duration-300">
        <div class="flex flex-col md:flex-row h-[580px]">
            <!-- Sidebar Section -->
            <div class="md:w-1/3 bg-indigo-50 p-3 border-r border-gray-200 flex flex-col">
                <div class="mb-3 flex items-center">
                    <div class="rounded-full bg-indigo-600 p-2 mr-2 relative animate-pulse-ring">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <h1 class="text-lg font-bold text-gray-800">Document AI</h1>
                    <span class="ml-auto px-2 py-1 bg-green-100 text-green-800 text-xs rounded-md">LIVE</span>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-3 border border-gray-100 mb-3">
                    <h2 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-file-pdf text-indigo-600 mr-2"></i>
                        Upload Document
                    </h2>
                    <form id="pdf-upload-form" class="space-y-2">
                        <div class="border-2 border-dashed border-indigo-200 p-3 rounded-lg transition-all duration-200 hover:border-indigo-500 group bg-indigo-50 bg-opacity-30 cursor-pointer">
                            <input 
                                type="file" 
                                id="pdf-file" 
                                name="pdf-file" 
                                accept=".pdf" 
                                class="hidden"
                                aria-label="Upload PDF document"
                            />
                            <label 
                                for="pdf-file" 
                                class="cursor-pointer block text-center"
                            >
                                <i class="fas fa-cloud-upload-alt text-indigo-400 group-hover:text-indigo-600 text-2xl mb-1"></i>
                                <p class="text-xs text-gray-600 group-hover:text-indigo-600 font-medium">
                                    Click or drop PDF here
                                </p>
                            </label>
                            <p id="file-name" class="text-xs text-center mt-1 text-indigo-600 font-medium truncate"></p>
                        </div>
                        <button 
                            type="submit" 
                            id="upload-button"
                            class="w-full py-2 rounded-lg font-medium text-sm relative flex items-center justify-center btn-primary"
                            disabled
                        >
                            <span id="upload-button-text">Process Document</span>
                            <div id="upload-spinner" class="hidden absolute inset-0 flex items-center justify-center">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </button>
                    </form>
                    <div id="upload-status" class="mt-2 text-xs min-h-5"></div>
                </div>
                
                <div class="flex-1 bg-white rounded-lg shadow-sm p-3 border border-gray-100 mb-3">
                    <h2 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-info-circle text-indigo-600 mr-2"></i>
                        How It Works
                    </h2>
                    <ol class="text-xs text-gray-600 space-y-1 pl-4 list-decimal">
                        <li>Upload a PDF document</li>
                        <li>Wait for processing to complete</li>
                        <li>Ask questions about the document content</li>
                        <li>Get AI-powered answers based on the document</li>
                    </ol>
                </div>
                
                <div class="bg-indigo-600 text-white rounded-lg p-3 text-xs">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-lightbulb text-yellow-300 mr-2"></i>
                        <span class="font-semibold">PRO TIP</span>
                    </div>
                    <p>Ask specific questions about your document for the best results.</p>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="md:w-2/3 flex flex-col h-full bg-gray-50">
                <!-- Chat Header -->
                <div class="border-b border-gray-200 py-2 px-4 bg-white flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                        <h2 class="font-medium text-sm text-gray-700">Document Chat</h2>
                    </div>
                    <div class="flex space-x-1">
                        <button id="refresh-chat" class="text-gray-400 hover:text-indigo-600 p-1 rounded tooltip" data-tooltip="Refresh">
                            <i class="fas fa-sync-alt text-xs"></i>
                        </button>
                        <button id="clear-chat" class="text-gray-400 hover:text-indigo-600 p-1 rounded tooltip" data-tooltip="Clear chat">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Chat Messages Container -->
                <div 
                    id="chat-container" 
                    class="flex-grow p-4 overflow-y-auto custom-scrollbar space-y-3"
                >
                    <div id="welcome-message" class="flex justify-center message-appear">
                        <div class="bg-white text-gray-700 px-4 py-3 rounded-lg max-w-md text-center shadow-sm border border-indigo-100">
                            <div class="bg-indigo-600 w-10 h-10 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                            <h3 class="font-medium text-sm mb-2">Welcome to Document AI!</h3>
                            <p class="text-xs text-gray-600">Upload a PDF document to get started. I'll analyze it and answer your questions based on its content.</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="border-t border-gray-200 p-3 bg-white relative">
                    <form id="chatbot-form" class="flex space-x-2 min-h-[46px]">
                        <input 
                            type="text" 
                            id="messageText"
                            name="messageText"
                            placeholder="Ask about your document..." 
                            class="flex-grow border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300 transition"
                            required
                            disabled
                            aria-label="Message input"
                        />
                        <button 
                            type="submit" 
                            class="px-3 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap btn-primary text-sm"
                            disabled
                            id="send-button"
                        >
                            <i class="fas fa-paper-plane md:mr-1"></i>
                            <span class="hidden md:inline">Send</span>
                        </button>
                    </form>
                    <p id="input-status" class="text-xs text-gray-500 mt-1 text-center">Upload a document to start chatting</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script>
    $(function() {
        const messageInput = $('#messageText');
        const sendButton = $('#send-button');
        const chatContainer = $('#chat-container');
        const uploadForm = $('#pdf-upload-form');
        const fileInput = $('#pdf-file');
        const uploadButton = $('#upload-button');
        const welcomeMessage = $('#welcome-message');
        
        // Initialize
        updateUploadButtonState();
        
        // Enable drag and drop for file upload
        const dropZone = $('#pdf-upload-form .border-dashed');
        
        dropZone.on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('border-indigo-500 bg-indigo-100');
        });
        
        dropZone.on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('border-indigo-500 bg-indigo-100');
        });
        
        dropZone.on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('border-indigo-500 bg-indigo-100');
            
            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                fileInput[0].files = files;
                handleFileSelection(files[0]);
            } else {
                $('#upload-status').html('<p class="text-red-500">Please upload a PDF file</p>');
            }
        });

        // File input enhancement
        fileInput.on('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });
        
        function handleFileSelection(file) {
            const fileName = file.name;
            const fileSize = file.size;
            const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(2);
            
            if (fileSize > 10 * 1024 * 1024) { // 10MB limit
                $('#file-name').html(`<span class="text-red-500">${fileName.length > 15 ? fileName.substr(0, 12) + '...' : fileName} (${fileSizeMB}MB)</span>`);
                $('#upload-status').html('<p class="text-red-500">File too large (max 10MB)</p>');
                uploadButton.prop('disabled', true);
            } else {
                $('#file-name').text(fileName.length > 15 ? fileName.substr(0, 12) + '...' : fileName);
                $('#upload-status').html('');
                uploadButton.prop('disabled', false);
            }
            
            updateUploadButtonState();
        }
        
        function updateUploadButtonState() {
            if (fileInput[0].files.length === 0) {
                uploadButton.prop('disabled', true);
            } else {
                uploadButton.prop('disabled', false);
            }
        }

        // PDF Upload Handler
        uploadForm.submit(function(e) {
            e.preventDefault();
            
            if (fileInput[0].files.length === 0) {
                $('#upload-status').html('<p class="text-amber-600">Please select a PDF file first</p>');
                return;
            }

            // Show loading spinner
            $('#upload-button-text').addClass('invisible');
            $('#upload-spinner').removeClass('hidden');
            $('#upload-button').prop('disabled', true);
            $('#upload-status').html('<p class="text-indigo-600"><i class="fas fa-spinner fa-spin mr-1"></i> Processing...</p>');

            var formData = new FormData(this);
            $.ajax({
                type: "POST",
                url: "/upload_pdf",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    // Hide loading spinner
                    $('#upload-button-text').removeClass('invisible');
                    $('#upload-spinner').addClass('hidden');
                    $('#upload-button').prop('disabled', false);

                    $('#upload-status').html('<p class="text-green-600"><i class="fas fa-check-circle mr-1"></i> Processed</p>');
                    
                    // Enable chat interface
                    messageInput.prop('disabled', false);
                    sendButton.prop('disabled', false);
                    $('#input-status').text('Ask questions about the document');
                    
                    // Remove welcome message
                    welcomeMessage.remove();
                    
                    // Add system message
                    addSystemMessage('success', 'Document Processed', 'Your document has been analyzed and is ready for questions. Try asking something specific about its content.');
                },
                error: function(error) {
                    // Hide loading spinner
                    $('#upload-button-text').removeClass('invisible');
                    $('#upload-spinner').addClass('hidden');
                    $('#upload-button').prop('disabled', false);

                    $('#upload-status').html(`<p class="text-red-500"><i class="fas fa-exclamation-circle mr-1"></i> Error</p>`);
                    addSystemMessage('error', 'Processing Failed', error.responseText || 'Could not process document.');
                }
            });
        });

        // Chatbot Functionality
        $('#chatbot-form').submit(function(e) {
            e.preventDefault();
            var message = messageInput.val().trim();
            
            if (!message) return;
            
            // Disable input while processing
            messageInput.prop('disabled', true);
            sendButton.prop('disabled', true);
            
            // Append user message
            addUserMessage(message);
            
            // Clear input field
            messageInput.val('');
            
            // Add typing indicator
            const typingIndicatorId = 'typing-indicator-' + Date.now();
            chatContainer.append(`
                <div id="${typingIndicatorId}" class="flex mb-3 message-appear">
                    <div class="bg-white p-2 rounded-lg shadow-sm max-w-[85%] flex items-center">
                        <div class="typing-indicator px-2 py-1">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `);
            scrollToBottom();

            $.ajax({
                type: "POST",
                url: "/ask",
                data: $(this).serialize(),
                success: function(response) {
                    // Remove typing indicator
                    $(`#${typingIndicatorId}`).remove();
                    
                    // Process markdown in response
                    const markedResponse = marked.parse(response.answer);
                    
                    // Append bot response
                    addBotMessage(markedResponse);
                    
                    // Re-enable input
                    messageInput.prop('disabled', false);
                    sendButton.prop('disabled', false);
                    messageInput.focus();
                },
                error: function(error) {
                    // Remove typing indicator
                    $(`#${typingIndicatorId}`).remove();
                    
                    // Show error message
                    addSystemMessage('error', 'Error', error.responseText || 'Failed to get response');
                    
                    // Re-enable input
                    messageInput.prop('disabled', false);
                    sendButton.prop('disabled', false);
                }
            });
        });
        
        // Add user message
        function addUserMessage(message) {
            chatContainer.append(`
                <div class="flex justify-end mb-3 message-appear">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg max-w-[85%] shadow-sm text-sm">
                        ${escapeHTML(message)}
                    </div>
                </div>
            `);
            scrollToBottom();
        }
        
        // Add bot message
        function addBotMessage(message) {
            chatContainer.append(`
                <div class="flex mb-3 message-appear">
                    <div class="bg-white text-gray-800 p-3 rounded-lg max-w-[85%] shadow-sm markdown text-sm">
                        ${message}
                    </div>
                </div>
            `);
            scrollToBottom();
        }
        
        // Add system message
        function addSystemMessage(type, title, message) {
            let icon, bgColor, borderColor;
            
            switch(type) {
                case 'success':
                    icon = 'check-circle';
                    bgColor = 'bg-green-50';
                    borderColor = 'border-green-100';
                    break;
                case 'error':
                    icon = 'exclamation-circle';
                    bgColor = 'bg-red-50';
                    borderColor = 'border-red-100';
                    break;
                case 'info':
                default:
                    icon = 'info-circle';
                    bgColor = 'bg-indigo-50';
                    borderColor = 'border-indigo-100';
            }
            
            chatContainer.append(`
                <div class="flex justify-center mb-3 message-appear">
                    <div class="${bgColor} text-gray-700 px-4 py-3 rounded-lg max-w-md text-center shadow-sm border ${borderColor}">
                        <i class="fas fa-${icon} text-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'indigo'}-500 mb-1"></i>
                        <h3 class="font-medium text-sm">${title}</h3>
                        <p class="text-xs text-gray-600">${message}</p>
                    </div>
                </div>
            `);
            scrollToBottom();
        }
        
        // Clear chat
        $('#clear-chat').click(function() {
            chatContainer.html(`
                <div class="flex justify-center message-appear">
                    <div class="bg-white text-gray-700 px-4 py-3 rounded-lg max-w-md text-center shadow-sm border border-indigo-100">
                        <div class="bg-indigo-600 w-10 h-10 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <h3 class="font-medium text-sm mb-2">Chat cleared!</h3>
                        <p class="text-xs text-gray-600">You can continue asking questions about the uploaded document.</p>
                    </div>
                </div>
            `);
        });
        
        // Refresh chat
        $('#refresh-chat').click(function() {
            location.reload();
        });
        
        // Escape HTML content
        function escapeHTML(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Auto-scroll to bottom
        function scrollToBottom() {
            chatContainer.scrollTop(chatContainer[0].scrollHeight);
        }
        
        // Handle Enter key in input
        messageInput.on('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendButton.prop('disabled')) {
                    $('#chatbot-form').submit();
                }
            }
        });
    });
    </script>
</body>
</html>